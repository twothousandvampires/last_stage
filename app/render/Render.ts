import ImageData from "./ImageData"
import Armour from "./src/sprites/Effect/Armour"
import AttackingGhostCultist from "./src/sprites/Effect/AttackingGhostCultist"
import BannerOfArmour from "./src/sprites/Effect/BannerOfArmour"
import BigFrostnova from "./src/sprites/Effect/BigFrostnova"
import BigShocknova from "./src/sprites/Effect/BigShocknova"
import Blood from "./src/sprites/Effect/blood"
import BloodShard from "./src/sprites/Effect/BloodShard"
import BloodSphere from "./src/sprites/Effect/BloodSphere"
import BoneArmour from "./src/sprites/Effect/BoneArmour"
import BoneExplosion from "./src/sprites/Effect/BoneExplosion"
import ChargedSphere from "./src/sprites/Effect/ChargedSphere"
import Curse from "./src/sprites/Effect/Curse"
import CurseArea from "./src/sprites/Effect/CurseArea"
import fireExplosion from "./src/sprites/Effect/FireExplosion"
import FireExplosionMedium from "./src/sprites/Effect/FireExplosionMedium"
import FireExplosionSmall from "./src/sprites/Effect/FireExplosionSmall"
import Flame from "./src/sprites/Effect/Flame"
import FrostExplosionBig from "./src/sprites/Effect/FrostExplosionBig"
import FrostExplosionMedium from "./src/sprites/Effect/FrostExplosionMedium"
import FrostNova from "./src/sprites/Effect/FrostNova"
import GhostGrip from "./src/sprites/Effect/GhostGrip"
import GhostGripArea from "./src/sprites/Effect/GhostGripArea"
import Grace from "./src/sprites/Effect/Grace"
import GraceShard from "./src/sprites/Effect/GraceShard"
import GroundHit from "./src/sprites/Effect/GroundHit"
import Intervention from "./src/sprites/Effect/Intervention"
import LightningBolt from "./src/sprites/Effect/LightningBolt"
import Quake from "./src/sprites/Effect/Quake"
import RocksFromCeil from "./src/sprites/Effect/RocksFromCeil"
import Rune from "./src/sprites/Effect/Rune"
import RuneExplode from "./src/sprites/Effect/RuneExplode"
import SharpedBone from "./src/sprites/Effect/SharpedBone"
import SmallShockNova from "./src/sprites/Effect/SmallShockNova"
import SpecterVortex from "./src/sprites/Effect/SpecterVortex"
import SplitOfEntity from "./src/sprites/Effect/SplitOfEntity"
import Star from "./src/sprites/Effect/Star"
import StaticField from "./src/sprites/Effect/StaticField"
import Teacher from "./src/sprites/Effect/Teacher"
import ToothExplode from "./src/sprites/Effect/ToothExplode"
import WalkingGhostCultist from "./src/sprites/Effect/WalkingGhostCultist"
import Bones from "./src/sprites/Enemy/Bones"
import FlamySprite from "./src/sprites/Enemy/FlamySprite"
import FlyingBones from "./src/sprites/Enemy/FlyingBones"
import FrostSpire from "./src/sprites/Enemy/FrostSpire"
import Gifter from "./src/sprites/Enemy/Gifter"
import ImpySprite from "./src/sprites/Enemy/ImpySprite"
import Pile from "./src/sprites/Enemy/Pile"
import Skull from "./src/sprites/Enemy/Skull"
import Solid from "./src/sprites/Enemy/Solid"
import Spectre from "./src/sprites/Enemy/Spectre"
import Cultist from "./src/sprites/Player/Cultist"
import FlyerSprite from "./src/sprites/Player/FlyerSprite"
import PlayerSprite from "./src/sprites/Player/PlayerSprite"
import BigFrostSphere from "./src/sprites/Proj/BigFrostSphere"
import Fireball from "./src/sprites/Proj/Fireball"
import FlamyFireball from "./src/sprites/Proj/FlamyFireball"
import Lightning from "./src/sprites/Proj/Lightning"
import SpecterSoulSeeker from "./src/sprites/Proj/SpecterSoulSeeker"
import ThrowedWeapon from "./src/sprites/Proj/ThrowedWeapon"
import Tooth from "./src/sprites/Proj/Tooth"
import WeaponFragment from "./src/sprites/Proj/WeaponFragment"
import Boss from "./src/sprites/Boss/Boss"
import Statue from "./src/sprites/Enemy/Statue"
import MagicStar from "./src/sprites/Effect/MagicStar"
import BurningCircle from "./src/sprites/Effect/BurningCircle"
import SkullCloud from "./src/sprites/Effect/SkullCloud"
import SmallTextL1 from "./src/sprites/Effect/SmallTextL1"
import SmallTextL2 from "./src/sprites/Effect/SmallTextL2"
import SmallTextL3 from "./src/sprites/Effect/SmallTextL3"
import TextLanguage1 from "./src/sprites/Effect/TextLanguage1"
import TextLanguage2 from "./src/sprites/Effect/TextLanguage2"
import TextLanguage3 from "./src/sprites/Effect/TextLanguage3"
import ClosedGate from "./src/sprites/Effect/ClosedGate"
import Forger from "./src/sprites/Effect/Forger"
import Gate from "./src/sprites/Effect/Gate"
import StrangeLanguage from "./src/sprites/Effect/StrangeLanguage"
import Ghost from "./src/sprites/Enemy/Ghost"
import FrostBolt from "./src/sprites/Proj/FrostBolt"
import Slime from "./src/sprites/Enemy/Slime"
import PuddleOfPoison from "./src/sprites/Effect/PuddleOfPoison"
import PuddleOfStream from "./src/sprites/Effect/PuddleOfStream"
import MagicSlime from "./src/sprites/Enemy/MagicSlime"
import ShadowDrop from "./src/sprites/Effect/ShadowDrop"
import Gold from "./src/sprites/Effect/Gold"
import Spark from "./src/sprites/Effect/Spark"
import SpectralSword from "./src/sprites/Enemy/SpectralSword"
import FlyingMucus from "./src/sprites/Effect/FlyingMucus"
import Ward from "./src/sprites/Effect/Ward"
import ItemDrop from "./src/sprites/Effect/ItemDrop"
import MetalThorns from "./src/sprites/Effect/MetalThorns"
import ElementalEnchanted from "./src/sprites/Effect/ElementalEnchanted"
import UnholyPower from "./src/sprites/Effect/UnholyPower"
import UnholySkull from "./src/sprites/Effect/UnholySkull"
import LigthNova from "./src/sprites/Effect/LigthNova"
import Soul from "./src/sprites/Effect/Soul"
import UnholySpirit from "./src/sprites/Effect/UnholySpirit"
import Input from "./Input"
import HeavenRay from "./src/sprites/Effect/HeavenRay"
import SorcerersSkull from "./src/sprites/Effect/SorcerersSkull"
import Bless from "./src/sprites/Effect/Bless"
import SorceryHalo from "./src/sprites/Effect/SorceryHalo"
import Reanimator from "./src/sprites/Effect/Reanimator"
import Helm from "./src/sprites/Effect/Helm"
import Devour from "./src/sprites/Effect/Devour"
import Heal from "./src/sprites/Effect/Heal"
import Ultimate1 from "./src/sprites/Effect/Ultimate1"
import Ultimate2 from "./src/sprites/Effect/Ultimate2"
import Ultimate3 from "./src/sprites/Effect/Ultimate3"
import UltimatumArena from "./src/sprites/Effect/UltimatumArena"
import FlamyRing from "./src/sprites/Effect/FlamyRing"

export default class Render{
    
    ctx: any
    canvas_scale: number
    player_img: any
    client_id: string
    actors: any
    light: boolean[][]
    data: ImageData
    bg: any
    bg_bottom: any
    socket: any
    downscale: number
    killed: number
    time: number
    input: any

    constructor(socket: any){
        this.client_id = socket.id
        this.socket = socket
        this.canvas_scale = 6
        this.actors = new Map()
        this.light = []
        this.downscale = 5
        this.time = 0
        this.killed = 0
        this.data = new ImageData()
        this.input = new Input(socket, this.canvas_scale)
        this.init()
    }

    getPlayerSprite(){
        return this.actors.get(this.client_id)
    }

    init(){
        this.ctx = document.getElementById('canvas').getContext('2d')
        this.ctx.scale(this.canvas_scale, this.canvas_scale)
        this.ctx.imageSmoothingEnabled  = false

        let bg_img = new Image()
        bg_img.src = './img/bg/bg.png'
        this.bg = bg_img

        let bg_botton = new Image()
        bg_botton.src = './img/bg/bg_bottom.png'
        this.bg_bottom = bg_botton

        this.initLightMap()
    }

    initLightMap() {
        for (let i = 0; i < 120; i++) {
            this.light[i] = []
            for (let j = 0; j < 120; j++) {
                this.light[i][j] = false
            }
        }
    }

    getSprite(elem: any){
        if(elem.name === 'swordman'){
            let sprite = new PlayerSprite(elem.id)
            return sprite
        }
        else if(elem.name === 'flyer'){
            let sprite = new FlyerSprite(elem.id) 
            return sprite
        }
        else if(elem.name === 'cultist'){
            let sprite = new Cultist(elem.id)
            return sprite
        }
        else if(elem.name === 'impy'){
            return new ImpySprite(elem.id)
        }
        else if(elem.name === 'bones'){
            return new Bones(elem.id)
        }
        else if(elem.name === 'flamy'){
            return new FlamySprite(elem.id)
        }
        else if(elem.name === 'split'){
            return new SplitOfEntity(elem.id)
        }
        else if(elem.name === 'grace shard'){
            return new GraceShard(elem.id)
        }
        else if(elem.name === 'solid'){
            return new Solid(elem.id)
        }
        else if(elem.name === 'skull'){
            return new Skull(elem.id)
        }
        else if(elem.name === 'flamy_fireball'){
            return new FlamyFireball(elem.id)
        }
        else if(elem.name === 'grace'){
            return new Grace(elem.id)
        }
        else if(elem.name === 'fire_explosion'){
            return new fireExplosion(elem.id)
        }
        else if(elem.name === 'armour'){
            return new Armour(elem.id)
        }
        else if(elem.name === 'throwed_weapon'){
            return new ThrowedWeapon(elem.id)
        }
        else if(elem.name === 'quake'){
            return new Quake(elem.id)
        }
        else if(elem.name === 'frostnova'){
            return new FrostNova(elem.id)
        }
        else if(elem.name === 'bone armour'){
            return new BoneArmour(elem.id)
        }
        else if(elem.name === 'bone explosion'){
            return new BoneExplosion(elem.id)
        }
        else if(elem.name === 'big frost sphere'){
            return new BigFrostSphere(elem.id)
        } 
        else if(elem.name === 'frost explosion big'){
            return new FrostExplosionBig(elem.id)
        }
        else if(elem.name === 'frost explosion medium'){
            return new FrostExplosionMedium(elem.id)
        }
        else if(elem.name === 'metal thorns'){
            return new MetalThorns(elem.id)
        }
        else if(elem.name === 'fire_explosion_medium'){
            return new FireExplosionMedium(elem.id)
        }
        else if(elem.name === 'fire_explosion_small'){
            return new FireExplosionSmall(elem.id)
        }
        else if(elem.name === 'fireball'){
            return new Fireball(elem.id)
        }
        else if(elem.name === 'lightning'){
            return new Lightning(elem.id)
        }
        else if(elem.name === 'flame'){
            return new Flame(elem.id)
        }
        else if(elem.name === 'big frostnova'){
            return new BigFrostnova(elem.id)
        }
        else if(elem.name === 'lightning bolt'){
            return new LightningBolt(elem.id)
        }
        else if(elem.name === 'rocks from ceil'){
            return new RocksFromCeil(elem.id)
        }
        else if(elem.name === 'charged sphere'){
            return new ChargedSphere(elem.id)
        }
        else if(elem.name === 'ground hit'){
            return new GroundHit(elem.id)
        }
        else if(elem.name === 'blood'){
            return new Blood(elem.id)
        }
        else if(elem.name === 'big shocknova'){
            return new BigShocknova(elem.id)
        }
        else if(elem.name === 'teacher'){
            return new Teacher(elem.id)
        }
        else if(elem.name === 'blood sphere'){
            return new BloodSphere(elem.id)
        }
        else if(elem.name === 'blood shard'){
            return new BloodShard(elem.id)
        }
        else if(elem.name === 'star'){
            return new Star(elem.id)
        }
        else if(elem.name === 'flying bones'){
            return new FlyingBones(elem.id)
        }
        else if(elem.name === 'elemental enchanted'){
            return new ElementalEnchanted(elem.id)
        }
        else if(elem.name === 'unholy power'){
            return new UnholyPower(elem.id)
        }
        else if(elem.name === 'unholy skull'){
            return new UnholySkull(elem.id)
        }
        else if(elem.name === 'sharped bone'){
            return new SharpedBone(elem.id)
        }
        else if(elem.name === 'ghost grip area'){
            return new GhostGripArea(elem.id)
        }
        else if(elem.name === 'ghost grip'){
            return new GhostGrip(elem.id)
        }
        else if(elem.name === 'curse of damned'){
            return new Curse(elem.id)
        }
        else if(elem.name === 'curse area'){
            return new CurseArea(elem.id)
        }
        else if(elem.name === 'tooth'){
            return new Tooth(elem.id)
        }
        else if(elem.name === 'tooth explode'){
            return new ToothExplode(elem.id)
        }
        else if(elem.name === 'magic star'){
            return new MagicStar(elem.id)
        }
        else if(elem.name === 'weapon fragment'){
            return new WeaponFragment(elem.id)
        }
        else if(elem.name === 'specter'){
            return new Spectre(elem.id)
        }
        else if(elem.name === 'specter vortex'){
            return new SpecterVortex(elem.id)
        }
        else if(elem.name === 'specter soul seeker'){
            return new SpecterSoulSeeker(elem.id)
        }
        else if(elem.name === 'rune'){
            return new Rune(elem.id)
        }
        else if(elem.name === 'rune explode'){
            return new RuneExplode(elem.id)
        }
        else if(elem.name === 'pile'){
            return new Pile(elem.id)
        }
        else if(elem.name === 'walking ghost cultist'){
            return new WalkingGhostCultist(elem.id)
        }
        else if(elem.name === 'attacking ghost cultist'){
            return new AttackingGhostCultist(elem.id)
        }
        else if(elem.name === 'ward'){
            return new Ward(elem.id)
        }
        else if(elem.name === 'banner of armour'){
            return new BannerOfArmour(elem.id)
        }
        else if(elem.name === 'burning circle'){
            return new BurningCircle(elem.id)
        }
        else if(elem.name === 'small shocknova'){
            return new SmallShockNova(elem.id)
        }
        else if(elem.name === 'frost spire'){
            return new FrostSpire(elem.id)
        }
        else if(elem.name === 'static field'){
            return new StaticField(elem.id)
        }
        else if(elem.name === 'intervention'){
            return new Intervention(elem.id)
        }
        else if(elem.name === 'gifter'){
            return new Gifter(elem.id)
        }
        else if(elem.name === 'item drop'){
            return new ItemDrop(elem.id)
        }
        else if(elem.name === 'boss'){
            return new Boss(elem.id)
        }
        else if(elem.name === 'statue'){
            return new Statue(elem.id)
        }
        else if(elem.name === 'skull cloud'){
            return new SkullCloud(elem.id)
        }
        else if(elem.name === 'small text l1'){
            return new SmallTextL1(elem.id)
        }
        else if(elem.name === 'small text l2'){
           return new SmallTextL2(elem.id)
        } 
        else if(elem.name === 'small text l3'){
            return new SmallTextL3(elem.id)
        }
        else if(elem.name === 'text l1'){
            return new TextLanguage1(elem.id)
        }
        else if(elem.name === 'text l2'){
            return new TextLanguage2(elem.id)
        }
        else if(elem.name === 'text l3'){
            return new TextLanguage3(elem.id)
        }
        else if(elem.name === 'closed gate'){
            return new ClosedGate(elem.id)
        }
        else if(elem.name === 'forger'){
            return new Forger(elem.id)
        }
        else if(elem.name === 'gate'){
            return new Gate(elem.id)
        }
        else if(elem.name === 'strange language'){
            return new StrangeLanguage(elem.id)
        }   
        else if(elem.name === 'ghost'){
            return new Ghost(elem.id)
        }
        else if(elem.name === 'frost bolt'){
            return new FrostBolt(elem.id)
        } 
        else if(elem.name === 'slime'){
            return new Slime(elem.id)
        } 
        else if(elem.name === 'puddle of poison'){
            return new PuddleOfPoison(elem.id)
        }
        else if(elem.name === 'puddle of stream'){
            return new PuddleOfStream(elem.id)
        }
        else if(elem.name === 'magic slime'){
            return new MagicSlime(elem.id)
        }
        else if(elem.name === 'shadow drop'){
            return new ShadowDrop(elem.id)
        }
        else if(elem.name === 'gold'){
            return new Gold(elem.id)
        }
        else if(elem.name === 'spark'){
            return new Spark(elem.id)
        }
        else if(elem.name === 'spectral sword'){
            return new SpectralSword(elem.id)
        }
        else if(elem.name === 'flying mucus'){
            return new FlyingMucus(elem.id)
        }
        else if(elem.name === 'light nova'){
            return new LigthNova(elem.id)
        }
        else if(elem.name === 'soul'){
            return new Soul(elem.id)
        }
        else if(elem.name === 'unholy spirit'){
            return new UnholySpirit(elem.id)
        }
        else if(elem.name === 'heal'){
            return new Heal(elem.id)
        }
        else if(elem.name === 'heaven ray'){
            return new HeavenRay(elem.id)
        }
        else if(elem.name === 'sorcerers skull'){
            return new SorcerersSkull(elem.id)
        }
        else if(elem.name === 'bless'){
            return new Bless(elem.id)
        }
        else if(elem.name === 'sorcery halo'){
            return new SorceryHalo(elem.id)
        }
        else if(elem.name === 'reanimator'){
            return new Reanimator(elem.id)
        }
        else if(elem.name === 'helm'){
            return new Helm(elem.id)
        }
        else if(elem.name === 'devour'){
            return new Devour(elem.id)
        }
        else if(elem.name === 'ultimatum1'){
            return new Ultimate1(elem.id)
        }
        else if(elem.name === 'ultimatum2'){
            return new Ultimate2(elem.id)
        }
        else if(elem.name === 'ultimatum3'){
            return new Ultimate3(elem.id)
        }
        else if(elem.name === 'ultimatum arena'){
            return new UltimatumArena(elem.id)
        }
        else if(elem.name === 'flamy ring'){
            return new FlamyRing(elem.id)
        }
    }

    public updateData(data: any){
        this.time = Math.floor(data.meta.ms / 1000)
        this.killed = data.meta.killed

        data.deleted.forEach(id => {
            this.actors.delete(id)
        })

        data.actors.forEach(elem => {
            let sprite = this.actors.get(elem.id)

            if(!sprite && !data.deleted.includes(elem.id)){
                sprite = this.getSprite(elem)
            
                if(sprite){
                    sprite.x = elem.x
                    sprite.y = elem.y
                    sprite.update(elem)
                    this.actors.set(elem.id, sprite)
                }
            }
            else if(!data.deleted.includes(elem.id)){
                sprite.update(elem)
            }
        })
    }

    private flipHorizontally(around){
        this.ctx.translate(around , 0)
        this.ctx.scale(-1, 1);
        this.ctx.translate(-around, 0)
    }

    drawLight(){
        this.ctx.fillStyle = 'black'
        for(let i = 0; i < 120; i++){
            for(let j = 0; j < 120; j++){
                if(!this.light[i][j]){
                    this.ctx.fillRect(j, i, 1 ,1)
                }
                else{
                    this.light[i][j] = false
                }
            }
        }
    }

    draw(){
        let client = this.actors.get(this.client_id)
        
        if(!client) return

        let rel_x = client.x
        let rel_y = client.y

        rel_x = (40 + client.level_id * 120 ) - rel_x
        rel_y = 40 - rel_y
        
        this.ctx.clearRect(0, 0, 120, 120)

        this.ctx.drawImage(this.bg, 120 * client.level_id, 0, 120, 120, rel_x, rel_y, 120, 120)

        let to_draw = Array.from(this.actors.values())

        to_draw.sort((a, b) => {if ( a.is_bottom && !b.is_bottom ){
            return -1
        }
        else{
            return  ((a.y + a.z) - (b.y + b.z))
        }
        })
        let t = undefined
        for(let i = 0; i < to_draw.length; i++){

            let elem = to_draw[i]

           
            if(elem.need_to_remove){
                this.actors.delete(elem.id)
                continue
            }

            let rel_x = client.x - elem.x
            let rel_y = client.y - elem.y

            rel_x = 40 - rel_x
            rel_y = 40 - rel_y
            
            if(elem.flipped){
                this.ctx.save()
                this.flipHorizontally(rel_x)
            }
            if(!elem.invisible){
                let sprite = this.data.map.get(elem.sprite_name)
                if(sprite){
                    if(elem.by_centr){
                        this.ctx.drawImage(
                        sprite,
                        elem.frame * elem.sprite_w,
                        elem.y_frame_offset + 1,
                        elem.sprite_w,
                        elem.sprite_h - 1,
                        rel_x - elem.sprite_w / (2 * this.downscale), 
                        rel_y - (elem.sprite_h / (2 * this.downscale)) - elem.z,
                        elem.sprite_w / this.downscale, 
                        elem.sprite_h / this.downscale)
                    }
                    else{
                        this.ctx.drawImage(
                        sprite,
                        elem.frame * elem.sprite_w,
                        elem.y_frame_offset + 1,
                        elem.sprite_w,
                        elem.sprite_h - 1,
                        rel_x - elem.sprite_w / (2 * this.downscale), 
                        rel_y - ( (elem.sprite_h / this.downscale) - 1) - elem.z,
                        elem.sprite_w / this.downscale, 
                        elem.sprite_h / this.downscale)
                    }
                }
                
            }
           
            if(elem.flipped){
                this.ctx.restore()
            }

            elem.act()
           
            if(!t && this.input.mobile && this.input.l_click && elem.real_x && elem.real_y){
                if(this.input.canvas_x >= rel_x - elem.real_x/2 && this.input.canvas_x <= rel_x + elem.real_x / 2 &&
                    this.input.canvas_y >= rel_y - elem.real_y && this.input.canvas_y <= rel_y
                ){
                    t = elem.id
                }
            }
            else if(!t && elem.id != client.id && this.input.mobile && this.input.touch_angle){
                const deltaX = elem.x -client.x
                const deltaY = elem.y -client.y
                
                // let angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                // angle = (angle - 90) % 360;

                let angle = Math.atan2(deltaY, deltaX)

                angle = -angle + Math.PI / 2;

                // Нормализуем в диапазон [0, 2π)
                if (angle < 0) {
                    angle += 2 * Math.PI;
                }
                if (angle >= 2 * Math.PI) {
                    angle -= 2 * Math.PI;
                }   
  
                let diff = Math.abs(this.input.touch_angle - angle)

                if(diff <= 0.5){
                    t = elem.id
                } 
            }

            if((elem.id === this.client_id) || (elem.light_r && elem.can_share_light)){
                let r = elem.light_r
                for (let i = -r; i <= r; i += 1) {
                    for (let j = -r; j <= r; j += 1) {
                        let y = i + Math.floor(rel_y - elem.z - elem.light_z) 
                        let x = j + Math.floor(rel_x)
                
                        if(y < 0 || x < 0 || x >= 120 || y >= 120) continue
                
                        let diff = Math.round(Math.sqrt(i * i + j * j))
                        if (diff <= r){
                            this.light[y][x] = true
                        }
                    }
                }
            }
        }
        if(t){
            this.socket.emit('set_target', t)
        }
        this.drawLight()
        this.ctx.drawImage(this.bg_bottom, 0, 0, 120, 120, rel_x, rel_y, 120, 120) 
    }
}